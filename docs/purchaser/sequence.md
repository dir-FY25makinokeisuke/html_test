# Bモジュール - シーケンス図

## 概要

購入処理・決済処理に関するシーケンスを示す。

## 購入処理シーケンス

```
ブラウザ          フロントエンド        APIサーバー         決済サービス       データベース
  |                   |                   |                   |                |
  |  購入ボタン押下    |                   |                   |                |
  |------------------>|                   |                   |                |
  |                   |  入力バリデーション |                   |                |
  |                   |------+            |                   |                |
  |                   |<-----+            |                   |                |
  |                   |  POST /api/purchase                   |                |
  |                   |------------------>|                   |                |
  |                   |                   |  在庫確認          |                |
  |                   |                   |---------------------------------->|
  |                   |                   |  在庫OK            |                |
  |                   |                   |<----------------------------------|
  |                   |                   |  決済リクエスト     |                |
  |                   |                   |------------------>|                |
  |                   |                   |  決済結果          |                |
  |                   |                   |<------------------|                |
  |                   |                   |  購入情報保存       |                |
  |                   |                   |---------------------------------->|
  |                   |                   |  保存完了           |                |
  |                   |                   |<----------------------------------|
  |                   |  200 OK           |                   |                |
  |                   |<------------------|                   |                |
  |  購入完了画面      |                   |                   |                |
  |<------------------|                   |                   |                |
```

## 購入履歴取得シーケンス

```
ブラウザ          フロントエンド        APIサーバー         データベース
  |                   |                   |                   |
  |  履歴画面アクセス  |                   |                   |
  |------------------>|                   |                   |
  |                   |  GET /api/purchase/history             |
  |                   |------------------>|                   |
  |                   |                   |  SELECT購入履歴    |
  |                   |                   |------------------>|
  |                   |                   |  購入履歴返却      |
  |                   |                   |<------------------|
  |                   |  200 OK (JSON)    |                   |
  |                   |<------------------|                   |
  |  履歴一覧表示      |                   |                   |
  |<------------------|                   |                   |
```

## エラーハンドリング

| エラー種別 | 処理 |
|-----------|------|
| 在庫不足 | ユーザーに在庫切れメッセージを表示し、カートに戻す |
| 決済失敗 | リトライ可能な場合は3回までリトライ。不可の場合はエラー画面を表示 |
| タイムアウト | 30秒でタイムアウトし、ステータスを `FAILED` に更新 |
| サーバーエラー | エラーログを出力し、ユーザーに再試行を促す |
